<?php

/**
 * Implements hook_form_FORM_ID_alter().
 */
function custom_blogs_form_user_form_alter(&$form, &$form_state, $form_id) {
  if (!\Drupal::currentUser()->hasPermission('administer_user')) {
    $form['account']['name']['#type'] = 'hidden';
    $form['field_user_last']['#type'] = 'hidden';
    $form['field_user_first']['#type'] = 'hidden';
    $form['field_user_display']['#type'] = 'hidden';
    $form['field_user_title']['#type'] = 'hidden';
  }
  if (empty($form['account']['name']['#default_value'])) {
    $form['account']['name']['#value'] = user_password();
  }
  array_unshift($form['#validate'], '_custom_blogs_form_user_register_validate');
}

/**
 * custom_validate for user_form_alter().
 */
function _custom_blogs_form_user_register_validate(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  $email = $form_state->getValue('mail');
  $uname = NULL;
  if ($email) {
    $uname = explode('@', $email);
    if ($uname[1] == 'umich.edu') {
      $uname = $uname[0];
    }
    else {
      $uname = $email;
    }
  }
  if ($uname) {
    $form_state->setValue('name', $uname);
    $form_state->setValue('edit_name', $uname);
    $user_data = _get_mcommunity_user($uname);
    if ($user_data) {
      $form_state->setValue(['field_user_last', 0, 'value'], $user_data['sn']);
      $form_state->setValue(['field_user_first', 0, 'value'], $user_data['givenname']);
      $form_state->setValue(['field_user_display', 0, 'value'], $user_data['displayname']);
      $form_state->setValue(['field_user_title', 0, 'value'], $user_data['umichtitle']);
    }
  }
  else {
    $form_state->setErrorByName('blogs_username_error', t('Cannot create user ' . $uname));
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function custom_blogs_form_og_membership_default_add_form_alter(&$form, &$form_state, $form_id) {
  // Note: requires create_user_permission module.
  if (\Drupal::currentUser()->hasPermission('create users')  || \Drupal::currentUser()->hasPermission('administer_user')) {
    array_unshift($form['#validate'], '_custom_blogs_form_og_membership_add_validate');
    $form['uid']['widget'][0]['target_id']['#description'] = \Drupal\Core\Field\FieldFilteredMarkup::create('<p>Select an existing user from the dropdown menu after typing the first few letters OR<br/>enter a UM Id or an email address.<br/>Non UM email addresses will need a friend account created. See <a href="https://documentation.its.umich.edu/node/305" target="_blank">Create a Friend Account for Guest Access to U-M Computing Resources</a> for details.</p>');
  }
}

/**
 * custom_validate for og_membership_default_add_form_alter().
 */
function _custom_blogs_form_og_membership_add_validate(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  if (empty($form_state->getValue('uid')[0]['target_id'])) {
    $user_input = $form_state->getUserInput();
    $new_user_name = trim($user_input['uid'][0]['target_id']);
    $uname = explode('@', $new_user_name);
    if ($uname[1] == 'umich.edu') {
      $new_user_name = $uname[0];
    }
    $new_user_roles = $user_input['roles'];
    foreach ($new_user_roles as $key => $role) {
      if (!empty($role)) {
       $role = str_replace('node-', '', $role);
       $role = str_replace('-', '_', $role);
       $new_user_roles[] = $role;
      }
      unset($new_user_roles[$key]);
    }
    $new_user_roles[] = 'blog_drafter';
    $new_user = NULL;
    if (strpos($new_user_name, '@') === FALSE) {
      if (user_validate_name($new_user_name)) {
        $form_state->setErrorByName('uid', t('The username %name is not valid.', array('%name' => $new_user_name)));
        return;
      }
      $user_data = _get_mcommunity_user($new_user_name);
      if (isset($user_data['mail']) && !empty($user_data['mail'])) {
        $new_user = \Drupal\user\Entity\User::create([
            'name' => $new_user_name,
            'mail' => $user_data['mail'],
            'pass' => user_password(),
            'status' => 1,
            'roles' => $new_user_roles,
        ]);
        if (!empty($user_data['sn'])) {
          $new_user->get('field_user_last')->setValue([['value' => $user_data['sn']]]);
        }
        if (!empty($user_data['givenname'])) {
          $new_user->get('field_user_first')->setValue([['value' => $user_data['givenname']]]);
        }
        if (!empty(trim($user_data['displayname']))) {
          $new_user->get('field_user_display')->setValue([['value' => $user_data['displayname']]]);
        }
        else if (!empty($user_data['sn']) && !empty($user_data['givenname'])) {
          $new_user->get('field_user_display')->setValue([['value' => $user_data['givenname'].' '.$user_data['sn']]]);
        }
        if (!empty($user_data['umichtitle'])) {
          $new_user->get('field_user_title')->setValue([['value' => $user_data['umichtitle']]]);
        }
      }
    }
    else {
      if (!\Drupal::service('email.validator')->isValid($new_user_name)) {
        $form_state->setErrorByName('uid', t('The email address %mail is not valid.', array('%mail' => $new_user_name)));
        return;
      }
      if (user_validate_name($new_user_name)) {
        $form_state->setErrorByName('uid', t('The username %name is not valid.', array('%name' => $new_user_name)));
        return;
      }
      $message = \Drupal\Core\Render\Markup::create('<strong>There must be a friend account associated with this email address for user with id '.$new_user_name.' to log into this site. See <a href="https://documentation.its.umich.edu/node/305" target="_blank">Create a Friend Account for Guest Access to U-M Computing Resources</a></strong>');
      $messenger = \Drupal::messenger();
      $messenger->addMessage($message, $messenger::TYPE_WARNING);
      $new_user = \Drupal\user\Entity\User::create([
          'name' => $new_user_name,
          'mail' => $new_user_name,
          'pass' => user_password(),
          'status' => 1,
          'roles' => $new_user_roles,
      ]);
    }
    if ($new_user instanceof \Drupal\user\Entity\User) {
      $new_user->save();
      $form_state->setValue('uid', [['target_id' => $new_user->id()]]);
      $user_input['uid'][0]['target_id'] = $new_user->id();
      $form_state->setUserInput($user_input);
    }
    else {
      $message = \Drupal\Core\Render\Markup::create('<strong>No valid UM user was found with id '.$user_input['uid'][0]['target_id'].'. Please verify the id at <a href="https://mcommunity.umich.edu/" target="_blank">MCommunity</a> or enter a non UM email address and create a friend account at <a href="https://documentation.its.umich.edu/node/305" target="_blank">https://documentation.its.umich.edu/node/305</a>.</strong>');
      $messenger = \Drupal::messenger();
      $messenger->addMessage($message, $messenger::TYPE_ERROR);
    }
  }
}

/**
 * get data from mcommunity().
 */
function _get_mcommunity_user($name) {
  $user_data = [];
  if ($mcomm = \Drupal\Core\Site\Settings::get('mcommunity')) {
    $ldap_config = parse_ini_file($mcomm, TRUE);
    $ldap_resource = ldap_connect($ldap_config['connect']['uri']);
    ldap_bind($ldap_resource, $ldap_config['bind']['dn'], $ldap_config['bind']['pw']);
    $ldap_result = ldap_search(
      $ldap_resource,
      "ou=People,dc=umich,dc=edu",
      "(uid=".$name.")",
      ['entityid','displayName','title','mail','givenname','sn','umichtitle',]
    );
    $ldap_entries = ldap_get_entries($ldap_resource, $ldap_result);
    $raw_data = array_filter($ldap_entries[0], function($k) { return !is_numeric($k); }, ARRAY_FILTER_USE_KEY);
    foreach ($raw_data as $key => $data) {
      $user_data[$key] = $data[0];
    }
  }

  return $user_data;
}

/**
* Implements hook_ENTITY_TYPE_presave().
*/
function custom_blogs_paragraph_presave($entity) {
  if ($entity->bundle() == 'get_in_touch') {
    _custom_blogs_make_sure_we_delete_empty_paragraphs($entity);
  }
}

/**
* Implements hook_ENTITY_TYPE_insert().
*/
function custom_blogs_paragraph_insert($entity) {
  if ($entity->bundle() == 'get_in_touch') {
    _custom_blogs_make_sure_we_delete_empty_paragraphs($entity);
  }
}

/**
* Implements hook_ENTITY_TYPE_update().
*/
function custom_blogs_paragraph_update($entity) {
  if ($entity->bundle() == 'get_in_touch') {
    _custom_blogs_make_sure_we_delete_empty_paragraphs($entity);
  }
}

/**
* Implements hook_ENTITY_TYPE_view_alter().
*/
function custom_blogs_paragraph_view_alter(array &$build, Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display) {
  if ($entity->bundle() == 'get_in_touch') {
    $is_empty = _custom_blogs_make_sure_we_delete_empty_paragraphs($entity);
    if (!$is_empty) {
      $name = trim($entity->get('field_name')->value);
      $email = trim($entity->get('field_email')->value);
      if (empty($name)) {
        unset($build['field_name']);
      }
      else if (empty($email)) {
        unset($build['field_email']);
      }
    }
  }
}

/**
 * custom function to remove empty paragraphs().
 */
// see if https://www.drupal.org/project/paragraphs/issues/2877695 is ever solved.
function _custom_blogs_make_sure_we_delete_empty_paragraphs($entity) {
  $name = trim($entity->get('field_name')->value);
  $email = trim($entity->get('field_email')->value);
  if (empty($name) && empty($email)) {
    $entity->delete();
    return TRUE;
  }
  return FALSE;
}

/**
* Implements hook_ENTITY_TYPE_view_alter().
*/
function custom_blogs_node_view_alter(array &$build, Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display) {
  if ($entity->bundle() == 'blog_post') {
    $tags = $entity->get('field_blog_tag');
    if ($tags && isset($build['field_blog_tag'][0]['#url']) && $entity->get('og_audience')) {
      foreach ($tags as $delta => $tag) {
        $build['field_blog_tag'][$delta]['#url']->setOption('query', [
          'blog' => $entity->get('og_audience')->target_id,
        ]);
      }
    }
  }
}

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter().
 */
function custom_blogs_field_widget_entity_reference_paragraphs_form_alter(&$element, &$form_state, $context) {
  // Skip "Confirm deletion / Restore actions" behavior for all paragraphs.
  // see https://www.drupal.org/node/2831409
  $element['top']['links']['remove_button']['#paragraphs_mode'] = 'removed';
}

/**
 * Implements hook_page_attachments().
 */
function custom_blogs_page_attachments(array &$attachments) {
  $attachments['#attached']['library'][] = 'custom_blogs/login-return-page-link';
}

/**
 * Implements hook_preprocess_HOOK().
 */
function custom_blogs_preprocess_block(&$variables) {
  if ($variables['elements']["#plugin_id"] === 'system_menu_block:account') {
    $variables['#cache']['max-age'] = 0;
    $variables['elements']['#cache']['max-age'] = 0;
    if (!empty($variables['content']['#items']['user.page'])) {
      $variables['content']['#items']['user.page']['url'] = Drupal\Core\Url::fromUri('route:<nolink>');
      $variables['content']['#items']['user.page']['url']->setOption('attributes', ['data-drupal-link-system-path' => 'user']);
      $variables['content']['#items']['user.page']['title'] = t('@name', ['@name' => \Drupal::currentUser()->getDisplayName()]);
    }
  }
}

/**
 * Implements hook_link_alter().
 *
Abandoned due to https://www.drupal.org/node/2795443, https://www.drupal.org/node/3082473
function custom_blogs_link_alter(&$vars) {
  if (
    $vars['url']->isRouted()
    && $vars['url']->getRouteName() === 'user.page'
    && (string) $vars['text'] === (string) t('My account')
  ) {
    $vars['#cache']['max-age'] = 0;
    $vars['elements']['#cache']['max-age'] = 0;
    $vars['text'] = t('@name', ['@name' => \Drupal::currentUser()->getDisplayName()]);
    $vars['url'] = \Drupal\Core\Url::fromUri('route:<nolink>');
  }
}

/**
 * Implements hook_menu_local_tasks_alter().
 *
 * Change tab names.
 */
function custom_blogs_menu_local_tasks_alter(&$data, $route_name) {
  if ($route_name === 'entity.node.canonical') {
    /** @var \Drupal\node\Entity\Node $node */
    $node = \Drupal::routeMatch()->getParameter('node');
    $bundles = ['blog', 'blog_post'];
    if ($node && in_array($node->bundle(), $bundles)) {
      $bundle_label = str_replace('Blog ', '', $node->type->entity->label());
      $data['tabs'][0]['entity.node.edit_form']['#link']['title'] = 'Edit '.$bundle_label;
      $data['tabs'][0]['og.og_admin_routes:node.og_admin_routes']['#link']['title'] = 'Blog Members';
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function custom_blogs_form_views_exposed_form_alter(array &$form, $form_state, $form_id) {
  $path = \Drupal::service('path.current')->getPath();
  $view = $form_state->getStorage('view');
  if (($view['view']->id() == 'all_posts') && ($view['view']->current_display == 'block_1')) {
    //This moves the search button to the search box.
    $actions['actions'] = $form['actions'];
    unset($form['actions']);
    $positions = array_keys($form);
    $keys_position = array_search('keys', $positions);
    //Note that to actually move actions, it needs to be set within a numerically keyed array.
    array_splice($form, $keys_position + 1, 0, [$actions]);
  }
  //Unset these if we arent on the all-posts page with optional date
  if (($view['view']->id() == 'all_posts') && (!strpos($path, 'all-posts'))) {
    unset($form['keys']['#title']);
    unset($form['#info']['filter-keys']['label']);
    unset($form['blog']);
  }
  if (($view['view']->id() == 'recent_posts') && ($view['view']->current_display == 'block_1')) {
    //This alters the title of the search box and adds a reset link.
    $node = \Drupal::routeMatch()->getParameter('node');
    $blog_id = NULL;
    if (!$node) {
      $nid = \Drupal::request()->query->get('blog');
      if (is_numeric($nid)) {
        $node = \Drupal\node\Entity\Node::load($nid);
        $blog_id = $nid;
      }
    }
    else if ($node->hasField('og_audience')) {
      $blog_id = $node->get('og_audience')->target_id;
    }
    if ($blog_id) {
      $blog = \Drupal\node\Entity\Node::load($blog_id);
      if ($blog) {
        $form['#action'] = $blog->toUrl()->toString();
        $form['keys']['#title'] = $form['keys']['#title'] . ' ' . $blog->getTitle();
        $form['#info']['filter-keys']['label'] = $form['#info']['filter-keys']['label'] . ' ' . $blog->getTitle();
      }
    }
/*    elseif ($node->hasField('field_blog_post_group_ref')) {
      $blog_id = $node->get('field_blog_post_group_ref')->target_id;
      $blog = \Drupal\node\Entity\Node::load($blog_id);
      if ($blog) {
        $form['#action'] = $blog->toUrl()->toString();
        $form['keys']['#title'] = $form['keys']['#title'] . ' ' . $blog->getTitle();
        $form['#info']['filter-keys']['label'] = $form['#info']['filter-keys']['label'] . ' ' . $blog->getTitle();
      }
    }
*/
    else if ($node) {
      $form['keys']['#title'] = $form['keys']['#title'] . ' ' . $node->getTitle();
      $form['#info']['filter-keys']['label'] = $form['#info']['filter-keys']['label'] . ' ' . $node->getTitle();
    }
    if ($form['actions']['reset']['#access']) {
      $form['actions']['reset'] = ['#markup' => \Drupal\Core\Render\Markup::create('<div><a href="'.$form['#action'].'">Reset results list</a></div>')];
    }
  }
}

/**
 * Implements hook_block_view_alter().
 */
function custom_blogs_block_view_alter(array &$build, \Drupal\Core\Block\BlockPluginInterface $block) {
  if ($block->getDerivativeId() == 'recent_posts-block_1') {
    $node = \Drupal::routeMatch()->getParameter('node');
    if (!$node) {
      $nid = \Drupal::request()->query->get('blog');
      if (!is_numeric($nid)) {
        $build = [];
      }
    }
  }
  if ($block->getDerivativeId() == 'all_posts-page_1') {
    $node = \Drupal::routeMatch()->getParameter('node');
    if (\Drupal::routeMatch()->getParameter('node') || is_numeric(\Drupal::request()->query->get('blog'))) {
      $build = [];
    }
  }
}

/**
 * Implements hook_views_query_alter().
 */
function custom_blogs_views_query_alter(\Drupal\views\ViewExecutable $view, \Drupal\views\Plugin\views\query\QueryPluginBase $query) {
  if ($view->id() == 'manage_my_posts' && $view->current_display == 'page_2') {
    $configuration = [
      'type'       => 'INNER',
      'table'      => 'og_membership',
      'field'      => 'entity_id',
      'left_table' => 'node_field_data_node__og_audience',
      'left_field' => 'nid',
      'operator'   => '=',
      'extra'  => [[ 'field' => 'uid', 'value' => $view->args[0] ]],
    ];
    $join = \Drupal\views\Views::pluginManager('join')->createInstance('standard', $configuration);
    $query->addRelationship('og_membership', $join, 'node_field_data_node__og_audience');
  }
}

/**
 * Implements hook_views_pre_render().
 */
function custom_blogs_views_pre_render(\Drupal\views\ViewExecutable $view) {
  if ($view->id() == 'blogs_filtered_by_membership' && $view->current_display == 'entity_reference_1') {
    //arg[0] is loggedin user. pass to get memberships.
    //don't do anything if user is og administrator.
    $user = \Drupal\user\Entity\User::load($view->args[0]);
    if (!$user->hasPermission('administer organic groups')) {
      $og_view = \Drupal::entityTypeManager()
        ->getStorage('view')
        ->load('get_membership_ids')
        ->getExecutable();
      $og_view->initDisplay();
      $og_view->setDisplay('default');
      $og_view->setArguments([$view->args[0]]);
      $og_view->execute();
      $og_result = $og_view->result;
      $blog_ids = [];
      foreach ($og_result as $result) {
        $blog_ids[] = $result->_entity->getGroupId();
      }
      foreach ($view->result as $id => $value) {
        $nid = $value->_entity->id();
        if (!in_array($nid, $blog_ids)) {
          unset($view->result[$id]);
        }
      }
    }
  }
  if ($view->id() == 'blogroll_view' && $view->current_display == 'block_2') {
    //This removes the block if the field isnt set.
    if (count($view->result) == 1 && empty($view->result[0]->_entity->get('field_blogroll')->getValue())) {
      unset($view->result[0]);
    }
  }
  if ($view->id() == 'author' && $view->current_display == 'page_1') {
    $author_display_name = '';
    if (isset($view->args[0]) && $author = user_load_by_name($view->args[0])) {
      $author_display_name = $author->get('field_user_display')->value;
      if (isset($view->args[1])) {
        $author_names = [];
        $conjunction = ' or ';
        if (strpos($view->args[1], ',') !== FALSE) {
          $author_names = explode(',', $view->args[1]);
          $conjunction = ' and ';
        }
        else if (strpos($view->args[1], '+') !== FALSE) {
          $author_names = explode('+', $view->args[1]);
        }
        else if (strpos($view->args[1], ' ') !== FALSE) {
          $author_names = explode(' ', $view->args[1]);
        }
        else {
          $author_names[] = $view->args[1];
        }
        $last = array_key_last($author_names);
        foreach ($author_names as $key => $author_name) {
          if ($author_name != $view->args[0]) {
            $join = ', ';
            if ($key == $last) {
              $join = $conjunction;
            }
            $author = user_load_by_name($author_name);
            $author_display_name .= $join . $author->get('field_user_display')->value;
          }
        }
      }
      $view->setTitle('Posts by '. $author_display_name);
    }
  }
}

/**
+ * Implements hook_views_post_render().
+ */
function custom_blogs_views_post_render(\Drupal\views\ViewExecutable $view, array &$output, \Drupal\views\Plugin\views\cache\CachePluginBase $cache) {
  if ($view->id() == 'taxonomy_term' && $view->current_display == 'page_1') {
    if (isset($view->args[1]) && $view->args[1] != 'all') {
      $blog_id = $view->args[1];
      $blog = \Drupal\node\Entity\Node::load($blog_id);
      $title = $blog->getTitle();
      $view->setTitle($view->getTitle() . ' in Blog <em>' . $title . '</em>');
      unset($output['#view']->field['og_audience']);
    }
  }
  if ($view->id() == 'browse_by_tag' && $view->current_display == 'block_2') {
    if (isset($view->args[0]) && is_numeric($view->args[0])) {
      $blog_id = $view->args[0];
      $blog = \Drupal\node\Entity\Node::load($blog_id);
      $title = $blog->getTitle();
      $view->setTitle($view->getTitle() . ' in <em>' . $title . '</em>');
    }
  }
  if ($view->id() == 'recent_posts' && $view->current_display == 'block_1') {
    if (empty(\Drupal::request()->get('keys'))) {
      //This sets the title if the search keys are empty.
      $view->setTitle('Recent Posts');
    }
    else {
      $blog_id = $view->args[0];
      $blog = \Drupal\node\Entity\Node::load($blog_id);
      $title = $blog->getTitle();
      $view->setTitle('Posts in ' . $title);
    }
  }
}
